apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: minio

resources:
- https://github.com/blairdrummond/minio-gateway-opa/base
#- ../../../../minio-gateway-opa/base

replicas:
- name: minio-gateway-opa
  count: 0

patchesJson6902:
- target:
    version: v1
    kind: StatefulSet
    name: minio-gateway-etcd
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources
      value: {}

patchesStrategicMerge:
- |-
  apiVersion: networking.istio.io/v1alpha3
  kind: DestinationRule
  metadata:
    name: minio-gateway-etcd
  $patch: delete
- |-
   apiVersion: apps/v1
   kind: StatefulSet
   metadata:
     name: minio-gateway-etcd
   spec:
     template:
       spec:
         affinity:
           podAntiAffinity:
             preferredDuringSchedulingIgnoredDuringExecution:
               - podAffinityTerm:
                   labelSelector:
                     matchLabels:
                       app.kubernetes.io/name: minio-gateway
                       app.kubernetes.io/instance: minio-gateway-etcd
                   # Edit this
                   namespaces:
                     - "minio"
                   topologyKey: kubernetes.io/hostname
                 weight: 1
         containers:
           - name: etcd
             env:
               - name: MY_POD_NAME
                 valueFrom:
                   fieldRef:
                     fieldPath: metadata.name
               - name: ETCD_ADVERTISE_CLIENT_URLS
                 value: http://$(MY_POD_NAME).minio-gateway-etcd-headless:2379,http://minio-gateway-etcd:2379

               - name: ETCD_INITIAL_ADVERTISE_PEER_URLS
                 value: "http://$(MY_POD_NAME).minio-gateway-etcd-headless:2380"

               - name: ETCD_INITIAL_CLUSTER
                 value: "minio-gateway-etcd-0=http://minio-gateway-etcd-0.minio-gateway-etcd-headless:2380,minio-gateway-etcd-1=http://minio-gateway-etcd-1.minio-gateway-etcd-headless:2380,minio-gateway-etcd-2=http://minio-gateway-etcd-2.minio-gateway-etcd-headless:2380"

               - name: ETCD_CLUSTER_DOMAIN
                 value: minio-gateway-etcd-headless

#- |-
#   apiVersion: apps/v1
#   kind: Deployment
#   metadata:
#     name: minio-gateway
#   spec:
#     template:
#       spec:
#         containers:
#           - name: minio
#             env:
#               - name: MINIO_IDENTITY_OPENID_CONFIG_URL
#                 valueFrom:
#                   secretKeyRef:
#                     name: minio-gateway-openid-secret
#                     key: MINIO_IDENTITY_OPENID_CONFIG_URL
#               - name: MINIO_IDENTITY_OPENID_CLIENT_ID
#                 valueFrom:
#                   secretKeyRef:
#                     name: minio-gateway-openid-secret
#                     key: MINIO_IDENTITY_OPENID_CLIENT_ID
